---
description: Supabase conventions (local project, migrations, SSR auth, RLS)
globs:
  - "apps/api/supabase/**/*"
  - "packages/supabase/**/*"
  - "apps/app/**/*"
  - "apps/proxy/**/*"
alwaysApply: false
---
# Supabase (database + auth)

## Repo layout

- Local Supabase project: `apps/api/supabase/`
  - Schemas: `apps/api/supabase/schemas/*.sql`
  - Migrations: `apps/api/supabase/migrations/*.sql`
  - Functions: `apps/api/supabase/functions/*`
- Runtime clients & queries: `packages/supabase/` (import via `@proxed/supabase/*`)
- Generated types:
  - Public schema: `packages/supabase/src/types/db.generated.ts` (via `bun run supabase:generate`)
  - Functions schema (optional): `apps/api` script `generate-functions` writes `packages/supabase/src/types/functions.generated.ts`

## Commands (run from repo root)

- Start: `bun run supabase:start`
- Reset: `bun run supabase:reset`
- Migrate: `bun run supabase:migrate`
- New migration: `bun run supabase:migration:create`
- Typegen: `bun run supabase:generate`

## Auth (Next.js)

- Use the shared clients:
  - Server: `@proxed/supabase/server`
  - Browser: `@proxed/supabase/client`
  - Middleware session refresh: `@proxed/supabase/middleware`
- Do **not** use `@supabase/auth-helpers-nextjs`.
- Cookie integration must use **only** `getAll` / `setAll` (no `get`/`set`/`remove`).

## DB & RLS guidelines

- Prefer `snake_case` for tables/columns.
- Enable RLS on new tables and write explicit policies (avoid `FOR ALL`; separate select/insert/update/delete).
- Default to `security invoker`. If you must use `security definer`, always set an explicit `search_path` and fully-qualify referenced objects.
